"use strict";const{app:s,BrowserWindow:w,ipcMain:d,protocol:y}=require("electron"),{join:u}=require("path"),{fork:g}=require("child_process"),{autoUpdater:i}=require("electron-updater"),q=require("events"),a=new q,v=require("path"),m=300;let n;require("electron-squirrel-startup")&&s.quit();const C=s.requestSingleInstanceLock();C?s.on("second-instance",()=>{n&&(n.isMinimized()&&n.restore(),n.focus())}):s.quit();const P=s.isPackaged?u(process.resourcesPath,"artNetTc.js"):u(__dirname,"..","..","public","artNetTc.js"),r=g(P,{stdio:["pipe","pipe","pipe","ipc"]});r.stdout.pipe(process.stdout);r.stderr.pipe(process.stdout);const p=()=>{n=new w({width:m,height:280,autoHideMenuBar:!0,show:!1,title:"ArtTimecode Gen v"+s.getVersion(),transparent:!0,frame:!1,resizable:!1,hasShadow:!1,webPreferences:{preload:u(__dirname,"preload.js"),sandbox:!1}}),n.loadFile(u(__dirname,"../renderer/main_window/index.html")),n.on("closed",()=>s.quit()),n.on("ready-to-show",()=>n.show()),s.isPackaged};s.on("ready",()=>{y.registerFileProtocol("atom",(e,t)=>{const l=e.url.substr(6);t({path:v.normalize(`${__dirname}/${l}`)})}),r.on("message",e=>{switch(e.cmd){case"time":try{n.webContents.send("time",e.clock)}catch{}break;case"rate":a.emit("rate",e.rate);break;case"state":a.emit("state",e.state);break;case"speed":a.emit("speed",e.speed);break;case"output":a.emit("output",e.output);break}}),r.on("error",e=>{console.log(e)}),r.on("close",(e,t)=>{console.log("CLOSED",e,t)}),d.on("reactIsReady",()=>{n.webContents.send("message","React Is Ready"),s.isPackaged&&(n.webContents.send("message","App is packaged"),i.on("error",e=>n.webContents.send("updater",e)),i.on("checking-for-update",()=>n.webContents.send("updater","checking-for-update")),i.on("update-available",e=>n.webContents.send("updater","update-available",e)),i.on("update-not-available",e=>n.webContents.send("updater","update-not-available",e)),i.on("download-progress",e=>n.webContents.send("updater","download-progress",e)),i.on("update-downloaded",e=>n.webContents.send("updater","update-downloaded",e)),d.on("installUpdate",()=>i.quitAndInstall()),setTimeout(()=>i.checkForUpdates(),3e3),setInterval(()=>i.checkForUpdates(),1e3*60*60))});const h=async e=>new Promise(async(t,l)=>{const o=c=>{a.removeListener("rate",o),t(c)};a.on("rate",o),r.send({cmd:"rate",rate:e})}),b=async e=>new Promise(async(t,l)=>{const o=c=>{a.removeListener("state",o),t(c)};a.on("state",o),r.send({cmd:"state",state:e})}),f=async e=>new Promise(async(t,l)=>{const o=c=>{a.removeListener("speed",o),t(c)};a.on("speed",o),r.send({cmd:"speed",speed:e})}),k=async e=>new Promise(async(t,l)=>{const o=c=>{a.removeListener("output",o),t(c)};a.on("output",o),r.send({cmd:"consoleAddress",address:e})});d.handle("consoleAddress",async(e,t)=>await k(t)),d.handle("frameRate",async(e,t)=>await h(t)),d.handle("state",async(e,t)=>await b(t)),d.handle("speed",async(e,t)=>await f(t)),d.on("time",(e,t)=>{r.send({cmd:"time",time:t})}),d.on("close",()=>s.quit()),d.on("min",()=>n.minimize()),d.on("contentHeight",(e,t)=>{n.setSize(m,Math.ceil(t)+2,!1)}),p(),s.on("activate",()=>{w.getAllWindows().length===0&&p()})});s.on("will-quit",()=>r.kill("SIGKILL"));s.on("window-all-closed",()=>{process.platform!=="darwin"&&s.quit()});
